<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Idempotent Consumer Dashboard - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- 详情弹窗 -->
        <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b">
                    <h3 id="modalTitle" class="text-lg font-medium text-gray-900">统计详情</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="modalContent" class="p-6 overflow-y-auto max-h-[60vh]">
                    <!-- 动态内容 -->
                </div>
            </div>
        </div>
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i data-lucide="package" class="w-8 h-8 text-blue-600 mr-3"></i>
                        <h1 class="text-xl font-semibold text-gray-900">幂等消费者仪表板</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/dlq-test-guide.html" class="bg-purple-600 text-white px-3 py-1 rounded-md hover:bg-purple-700 transition-colors text-sm">
                            <i data-lucide="help-circle" class="w-4 h-4 inline mr-1"></i>
                            DLQ测试指南
                        </a>
                        <span id="connectionStatus" class="flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-gray-600">已连接</span>
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- 统计面板 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white shadow rounded-lg p-6 stat-card" data-stat="totalProcessed">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <i data-lucide="package" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">总处理消息</p>
                            <p id="totalProcessed" class="text-2xl font-semibold text-gray-900 cursor-pointer hover:text-blue-600 transition-colors" title="点击查看详情">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white shadow rounded-lg p-6 stat-card" data-stat="successfulOrders">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">成功订单</p>
                            <p id="successfulOrders" class="text-2xl font-semibold text-gray-900 cursor-pointer hover:text-blue-600 transition-colors" title="点击查看详情">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white shadow rounded-lg p-6 stat-card" data-stat="duplicateMessages">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">重复消息</p>
                            <p id="duplicateMessages" class="text-2xl font-semibold text-gray-900 cursor-pointer hover:text-blue-600 transition-colors" title="点击查看详情">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white shadow rounded-lg p-6 stat-card" data-stat="deadLetterMessages">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100">
                            <i data-lucide="x-circle" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">死信消息</p>
                            <p id="deadLetterMessages" class="text-2xl font-semibold text-gray-900 cursor-pointer hover:text-blue-600 transition-colors" title="点击查看详情">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作面板 -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium text-gray-900">快速操作</h2>
                    <div class="flex space-x-1">
                        <button id="refreshStatsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm" title="手动刷新数据">
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                            刷新统计
                        </button>
                        <button id="clearAllBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors text-sm">
                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                            清理所有
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button id="createOrderBtn" class="bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5 block mx-auto mb-1"></i>
                        <span class="text-sm font-medium">创建订单</span>
                    </button>
                    <button id="rapidTestBtn" class="bg-orange-600 text-white px-4 py-3 rounded-md hover:bg-orange-700 transition-colors">
                        <i data-lucide="zap" class="w-5 h-5 block mx-auto mb-1"></i>
                        <span class="text-sm font-medium">快速测试</span>
                    </button>
                    <button id="dlqTestBtn" class="bg-purple-600 text-white px-4 py-3 rounded-md hover:bg-purple-700 transition-colors">
                        <i data-lucide="layers" class="w-5 h-5 block mx-auto mb-1"></i>
                        <span class="text-sm font-medium">DLQ测试</span>
                    </button>
                    <button id="seedDataBtn" class="bg-gray-600 text-white px-4 py-3 rounded-md hover:bg-gray-700 transition-colors">
                        <i data-lucide="database" class="w-5 h-5 block mx-auto mb-1"></i>
                        <span class="text-sm font-medium">示例数据</span>
                    </button>
                </div>
            </div>

            <!-- 表单区域 -->
            <div id="orderFormPanel" class="bg-white shadow rounded-lg p-6 mb-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-lg font-medium text-gray-900">创建新订单</h2>
                        <p class="text-sm text-gray-500">表单提交后保持填充，支持快速重复测试</p>
                    </div>
                    <button id="closeFormBtn" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="orderForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Message ID
                                <span class="text-xs text-gray-500">(可选 - 留空自动生成)</span>
                            </label>
                            <input type="text" id="messageId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="留空自动生成">
                            <p class="text-xs text-gray-500 mt-1">用于幂等性 - 防止重复处理</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">客户名称</label>
                            <input type="text" id="customerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入客户名称" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">金额</label>
                            <input type="number" id="amount" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">时间戳</label>
                            <input type="datetime-local" id="timestamp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="clearFormBtn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            清空表单
                        </button>
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i data-lucide="check" class="w-4 h-4 inline mr-2"></i>
                            创建订单
                        </button>
                    </div>
                </form>
            </div>

            <!-- 消息队列区域 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 已处理消息 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-medium text-gray-900">已处理消息</h2>
                            <button id="refreshMessageQueueBtn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                                刷新
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="messageQueueContent" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                                <p>暂无处理的消息</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 死信队列 -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-medium text-gray-900">死信队列</h2>
                            <div class="flex space-x-2">
                                <button id="retryAllDLQBtn" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 transition-colors text-sm">
                                    <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                                    重试全部
                                </button>
                                <button id="clearDLQBtn" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 transition-colors text-sm">
                                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                    清空
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="deadLetterContent" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                                <p>暂无死信消息</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Notification Container -->
        <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Stats modal functionality
        const statsModal = document.getElementById('statsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');

        // Close modal
        closeModal.addEventListener('click', () => {
            statsModal.classList.add('hidden');
        });

        // Close modal when clicking outside
        statsModal.addEventListener('click', (e) => {
            if (e.target === statsModal) {
                statsModal.classList.add('hidden');
            }
        });

        // Show stats details
        async function showStatsDetails(statType) {
            const titles = {
                totalProcessed: '总处理消息详情',
                successfulOrders: '成功订单详情',
                duplicateMessages: '重复消息详情',
                deadLetterMessages: '死信消息详情'
            };

            modalTitle.textContent = titles[statType] || '统计详情';
            modalContent.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">加载中...</p></div>';
            statsModal.classList.remove('hidden');

            try {
                let data = [];

                switch (statType) {
                    case 'totalProcessed':
                        const messageQueue = await apiCall('/api/message-queue');
                        data = messageQueue;
                        break;
                    case 'successfulOrders':
                        const ordersResponse = await apiCall('/api/orders');
                        data = ordersResponse || [];
                        break;
                    case 'duplicateMessages':
                        const duplicates = await apiCall('/api/debug-duplicates');
                        data = duplicates.recentAttempts || [];
                        break;
                    case 'deadLetterMessages':
                        const dlqResponse = await apiCall('/api/dead-letter-queue');
                        data = dlqResponse.messages || [];
                        break;
                }

                displayStatsDetails(statType, data);
            } catch (error) {
                modalContent.innerHTML = `<div class="text-center py-8 text-red-600"><i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-3"></i><p>加载失败: ${error.message}</p></div>`;
                lucide.createIcons();
            }
        }

        // Display stats details in modal
        function displayStatsDetails(statType, data) {
            let content = '';

            if (data.length === 0) {
                content = '<div class="text-center py-8 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3"></i><p>暂无数据</p></div>';
            } else {
                switch (statType) {
                    case 'totalProcessed':
                        content = data.map(item => `
                            <div class="border rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">${item.messageId}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            消费者: ${item.consumerName} | 状态: ${item.status}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            处理时间: ${new Date(item.processedAt).toLocaleString()}
                                        </div>
                                        ${item.result ? `<div class="text-xs text-gray-500 mt-1">结果: ${item.result}</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        break;
                    case 'successfulOrders':
                        content = data.map(item => `
                            <div class="border rounded-lg p-4 mb-3 bg-green-50">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">订单: ${item.id}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            客户: ${item.customerName} | 金额: $${item.amount}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            创建时间: ${new Date(item.createdAt).toLocaleString()}
                                        </div>
                                        <div class="text-xs text-green-600 mt-1">
                                            状态: ${item.status === 'Completed' ? '已完成' : item.status}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        break;
                    case 'duplicateMessages':
                        content = data.map(item => `
                            <div class="border rounded-lg p-4 mb-3 bg-yellow-50">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">${item.messageId}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            消费者: ${item.consumerName} | 来源: ${item.source}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            检测时间: ${new Date(item.detectedAt).toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        break;
                    case 'deadLetterMessages':
                        content = data.map(item => `
                            <div class="border rounded-lg p-4 mb-3 bg-red-50">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">${item.originalMessageId}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            客户: ${item.customerName} | 金额: $${item.amount}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            失败原因: ${item.failureReason}
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            失败时间: ${new Date(item.failureTimestamp).toLocaleString()}
                                        </div>
                                    </div>
                                    <button onclick="retryDeadLetterMessage('${item.id}')" class="ml-4 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        重试
                                    </button>
                                </div>
                            </div>
                        `).join('');
                        break;
                }
            }

            modalContent.innerHTML = content;
            lucide.createIcons();
        }

        // Add click event listeners to stat cards
        document.addEventListener('DOMContentLoaded', () => {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('click', () => {
                    const statType = card.dataset.stat;
                    showStatsDetails(statType);
                });
            });
        });

        // API utility function
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');

            // 如果容器不存在，创建一个
            if (!container) {
                const newContainer = document.createElement('div');
                newContainer.id = 'notificationContainer';
                newContainer.className = 'fixed top-4 right-4 z-50 space-y-2';
                document.body.appendChild(newContainer);
            }

            const notification = document.createElement('div');

            const bgColor = type === 'success' ? 'bg-green-500' :
                           type === 'error' ? 'bg-red-500' :
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';

            notification.className = `notification ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-2`;
            notification.textContent = message;

            const targetContainer = document.getElementById('notificationContainer');
            targetContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update statistics
        async function updateStats() {
            try {
                console.log('=== 开始更新统计数据 ===');
                const response = await apiCall('/api/dead-letter-queue');
                console.log('API响应:', response);
                const stats = response.stats;
                console.log('统计数据对象:', stats);

                // 更新统计显示
                document.getElementById('totalProcessed').textContent = stats.totalProcessedMessages || 0;
                document.getElementById('successfulOrders').textContent = stats.successfulOrders || 0;
                document.getElementById('duplicateMessages').textContent = stats.duplicateMessagesDetected || 0;
                document.getElementById('deadLetterMessages').textContent = stats.deadLetterMessages || 0;

                // 详细日志用于调试
                console.log('=== 主页统计更新 ===');
                console.log('Total Processed:', stats.totalProcessedMessages);
                console.log('Successful Orders:', stats.successfulOrders);
                console.log('Duplicate Messages:', stats.duplicateMessagesDetected);
                console.log('Dead Letter Messages:', stats.deadLetterMessages);
                console.log('Messages array length:', response.messages ? response.messages.length : 0);
                console.log('=================');

                // 如果重复消息数为0，检查debug端点
                if (stats.duplicateMessagesDetected === 0) {
                    console.log('检查重复消息统计...');
                    try {
                        const debugResponse = await apiCall('/api/debug-duplicates');
                        console.log('Debug duplicates:', debugResponse);
                    } catch (debugError) {
                        console.error('无法获取debug信息:', debugError);
                    }
                }
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        // Load message queue
        async function loadMessageQueue() {
            try {
                const messages = await apiCall('/api/message-queue');

                const content = document.getElementById('messageQueueContent');

                if (messages.length === 0) {
                    content.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                            <p>暂无处理的消息</p>
                        </div>
                    `;
                } else {
                    content.innerHTML = messages.map(msg => `
                        <div class="border rounded-lg p-4 fade-in">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${msg.messageId}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        消费者: ${msg.consumerName} | 状态: ${msg.status}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        处理时间: ${new Date(msg.processedAt).toLocaleString()}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        结果: ${msg.result}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load message queue:', error);
            }
        }

        // Load dead letter queue
        async function loadDeadLetterQueue() {
            try {
                console.log('=== 开始加载死信队列 ===');
                const response = await apiCall('/api/dead-letter-queue');
                console.log('死信队列响应:', response);
                const messages = response.messages;
                console.log('死信消息数量:', messages ? messages.length : 0);

                const content = document.getElementById('deadLetterContent');

                if (messages.length === 0) {
                    content.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                            <p>暂无死信消息</p>
                        </div>
                    `;
                } else {
                    content.innerHTML = messages.map(msg => `
                        <div class="border rounded-lg p-4 fade-in">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">${msg.originalMessageId}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        客户: ${msg.customerName} | 金额: $${msg.amount}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        失败原因: ${msg.failureReason}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        失败时间: ${new Date(msg.failureTimestamp).toLocaleString()}
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="retryMessage('${msg.id}')" class="text-green-600 hover:text-green-800">
                                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load dead letter queue:', error);
            }
        }

        // Retry individual message
        async function retryMessage(id) {
            try {
                await apiCall(`/api/dead-letter-queue/${id}/retry`, { method: 'POST' });
                showNotification('消息已标记为重试', 'success');
                loadDeadLetterQueue();
                loadMessageQueue();
                await updateStats();
            } catch (error) {
                showNotification('重试失败: ' + error.message, 'error');
            }
        }

        // Initialize form
        function initForm() {
            const timestamp = document.getElementById('timestamp');
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            timestamp.value = now.toISOString().slice(0, 16);

            // Check URL parameters for auto-fill
            const urlParams = new URLSearchParams(window.location.search);
            const showForm = urlParams.get('showForm');
            const customer = urlParams.get('customer');
            const amount = urlParams.get('amount');

            if (showForm === 'true') {
                document.getElementById('orderFormPanel').classList.remove('hidden');
                document.getElementById('orderFormPanel').classList.add('fade-in');

                // Auto-fill form data
                if (customer) {
                    document.getElementById('customerName').value = customer;
                }
                if (amount) {
                    document.getElementById('amount').value = amount;
                }

                // Scroll to form
                document.getElementById('orderFormPanel').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM内容加载完成 ===');
            // Initialize
            initForm();
            console.log('开始调用updateStats...');
            updateStats();
            loadMessageQueue();
            loadDeadLetterQueue();

            // Auto-refresh functionality removed - manual refresh only

            // Auto-refresh initialization removed

            // Button event listeners
            document.getElementById('refreshStatsBtn').addEventListener('click', async () => {
                await updateStats();
                loadMessageQueue();
                loadDeadLetterQueue();
                showNotification('统计已刷新', 'success');
            });

            document.getElementById('clearAllBtn').addEventListener('click', async () => {
                if (confirm('确定要清理所有数据吗？此操作不可撤销。')) {
                    try {
                        await apiCall('/api/clear', { method: 'POST' });
                        showNotification('所有数据已清理', 'success');
                        await updateStats();
                        loadMessageQueue();
                        loadDeadLetterQueue();
                    } catch (error) {
                        showNotification('清理失败: ' + error.message, 'error');
                    }
                }
            });

            document.getElementById('createOrderBtn').addEventListener('click', () => {
                document.getElementById('orderFormPanel').classList.remove('hidden');
                document.getElementById('orderFormPanel').classList.add('fade-in');
            });

            document.getElementById('closeFormBtn').addEventListener('click', () => {
                document.getElementById('orderFormPanel').classList.add('hidden');
            });

  
            document.getElementById('rapidTestBtn').addEventListener('click', async () => {
                try {
                    // 使用固定的messageId来确保测试重复消息检测
                    const messageId = 'rapid-test-fixed-12345';
                    const testData = {
                        messageId: messageId,
                        customerName: 'Rapid Test Customer',
                        amount: 99.99,
                        timestamp: new Date().toISOString()
                    };

                    showNotification('正在发送3个相同消息进行重复检测测试...', 'info');

                    // Send 3 identical requests
                    const promises = [];
                    for (let i = 0; i < 3; i++) {
                        console.log(`发送第 ${i + 1} 个重复消息请求...`);
                        promises.push(apiCall('/api/orders', {
                            method: 'POST',
                            body: JSON.stringify(testData)
                        }));
                    }

                    const results = await Promise.all(promises);
                    const successCount = results.filter(r => r.success).length;

                    console.log('快速测试结果:', results);
                    showNotification(`快速测试完成！${successCount}/3 个请求成功处理。正在获取测试结果...`, 'success');

                    // 延迟获取测试结果，确保消息已被处理
                    setTimeout(async () => {
                        await showRapidTestResults('快速测试结果', messageId);
                    }, 1500);
                } catch (error) {
                    showNotification('快速测试失败: ' + error.message, 'error');
                    console.error('快速测试错误:', error);
                }
            });

            document.getElementById('dlqTestBtn').addEventListener('click', async () => {
                try {
                    const messageId = 'dlq-test-optimized-' + Date.now();
                    const testData = {
                        messageId: messageId,
                        customerName: 'DLQ Test Customer',
                        amount: 99.99
                    };

                    await apiCall('/api/test-dlq', {
                        method: 'POST',
                        body: JSON.stringify(testData)
                    });

                    showNotification('DLQ测试完成！正在获取测试结果...', 'success');

                    // 延迟获取DLQ结果，确保消息已被处理
                    setTimeout(async () => {
                        await showDLQResults('主页DLQ测试结果', [messageId]);
                    }, 1500);
                } catch (error) {
                    showNotification('DLQ测试失败: ' + error.message, 'error');
                }
            });

            document.getElementById('seedDataBtn').addEventListener('click', async () => {
                try {
                    const result = await apiCall('/api/seed', { method: 'POST' });
                    showNotification(result.message, 'success');

                    // Refresh data
                    setTimeout(async () => {
                        await updateStats();
                        loadMessageQueue();
                        loadDeadLetterQueue();
                    }, 1000);
                } catch (error) {
                    showNotification('示例数据创建失败: ' + error.message, 'error');
                }
            });

            document.getElementById('clearFormBtn').addEventListener('click', () => {
                document.getElementById('orderForm').reset();
                initForm();
            });

            document.getElementById('orderForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    messageId: document.getElementById('messageId').value || `order-${Date.now()}`,
                    customerName: document.getElementById('customerName').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    timestamp: new Date(document.getElementById('timestamp').value).toISOString()
                };

                try {
                    const result = await apiCall('/api/orders', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });

                    if (result.success) {
                        if (result.duplicate) {
                            showNotification('订单创建成功！检测到重复消息，已使用缓存结果。', 'success');
                        } else {
                            showNotification('订单创建成功！', 'success');
                        }

                        // 保持表单字段填充，支持快速重复测试
                        // 不重置表单，不隐藏表单面板

                        // Refresh data
                        setTimeout(async () => {
                            await updateStats();
                            loadMessageQueue();
                            loadDeadLetterQueue();
                        }, 1000);
                    } else {
                        showNotification('订单创建失败: ' + (result.error || '未知错误'), 'error');
                    }
                } catch (error) {
                    showNotification('订单创建失败: ' + error.message, 'error');
                }
            });

            document.getElementById('refreshMessageQueueBtn').addEventListener('click', () => {
                loadMessageQueue();
                showNotification('消息队列已刷新', 'success');
            });

            document.getElementById('retryAllDLQBtn').addEventListener('click', async () => {
                try {
                    const response = await apiCall('/api/dead-letter-queue');

                    // Check if response and messages exist
                    if (!response || !response.messages) {
                        showNotification('无法获取死信队列数据', 'error');
                        return;
                    }

                    const messages = response.messages;

                    if (!Array.isArray(messages) || messages.length === 0) {
                        showNotification('没有需要重试的消息', 'success');
                        return;
                    }

                    let successCount = 0;

                    for (const msg of messages) {
                        // Check if message has id property
                        if (!msg || !msg.id) {
                            console.error('Invalid message object:', msg);
                            continue;
                        }

                        try {
                            await apiCall(`/api/dead-letter-queue/${msg.id}/retry`, { method: 'POST' });
                            successCount++;
                        } catch (error) {
                            console.error(`Failed to retry message ${msg.id}:`, error);
                        }
                    }

                    showNotification(`已成功重试 ${successCount}/${messages.length} 条消息`, successCount > 0 ? 'success' : 'warning');

                    // Refresh data
                    setTimeout(async () => {
                        await updateStats();
                        loadMessageQueue();
                        loadDeadLetterQueue();
                    }, 1000);
                } catch (error) {
                    console.error('Retry all error:', error);
                    showNotification('重试失败: ' + (error.message || '未知错误'), 'error');
                }
            });

            document.getElementById('clearDLQBtn').addEventListener('click', async () => {
                if (confirm('确定要清空所有死信消息吗？此操作不可撤销。')) {
                    try {
                        const response = await apiCall('/api/dead-letter-queue');

                        // Check if response and messages exist
                        if (!response || !response.messages) {
                            showNotification('无法获取死信队列数据', 'error');
                            return;
                        }

                        const messages = response.messages;

                        if (!Array.isArray(messages) || messages.length === 0) {
                            showNotification('没有需要清理的消息', 'success');
                            return;
                        }

                        // Clear all DLQ messages by calling the clear API endpoint
                        await apiCall('/api/clear', { method: 'POST' });

                        showNotification(`已清理 ${messages.length} 条死信消息`, 'success');

                        // Refresh data
                        setTimeout(async () => {
                            await updateStats();
                            loadMessageQueue();
                            loadDeadLetterQueue();
                        }, 1000);
                    } catch (error) {
                        console.error('Clear DLQ error:', error);
                        showNotification('清理失败: ' + (error.message || '未知错误'), 'error');
                    }
                }
            });
        });

        // 显示DLQ结果 - 支持消息ID过滤
        async function showDLQResults(title, messageIds = null) {
            try {
                const response = await fetch('/api/dead-letter-queue');
                const data = await response.json();
                let messages = data.messages || [];
                const stats = data.stats || {};

                // 如果提供了messageIds，则过滤显示只相关的消息
                let filteredMessages = messages;
                let filteredStats = { ...stats };

                if (messageIds && messageIds.length > 0) {
                    filteredMessages = messages.filter(msg =>
                        messageIds.includes(msg.originalMessageId)
                    );

                    // 更新统计信息以反映过滤后的结果
                    filteredStats.deadLetterMessages = filteredMessages.length;

                    // 计算过滤后的消息中成功重试的数量
                    const successfulInFiltered = filteredMessages.filter(msg =>
                        msg.status === 'Processed' || msg.failureReason === 'Successfully processed'
                    ).length;

                    // 如果过滤后的消息都是成功的，更新成功订单统计
                    if (successfulInFiltered > 0 && filteredMessages.length === successfulInFiltered) {
                        filteredStats.successfulOrders = successfulInFiltered;
                    }
                }

                // 创建模态框显示结果
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-xl font-semibold text-gray-900">${title}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            ${messageIds && messageIds.length > 0 ?
                                `<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                    <div class="flex items-center">
                                        <i data-lucide="filter" class="w-5 h-5 text-blue-600 mr-2"></i>
                                        <span class="text-blue-800 font-medium">显示本次测试创建的 ${filteredMessages.length} 个DLQ消息</span>
                                    </div>
                                </div>` :
                                ''
                            }

                            <!-- 统计信息 -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-red-600">${filteredStats.deadLetterMessages || 0}</div>
                                    <div class="text-sm text-gray-600">死信消息</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600">${filteredStats.totalProcessedMessages || 0}</div>
                                    <div class="text-sm text-gray-600">总处理消息</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600">${filteredStats.successfulOrders || 0}</div>
                                    <div class="text-sm text-gray-600">成功订单</div>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-yellow-600">${filteredStats.duplicateMessagesDetected || 0}</div>
                                    <div class="text-sm text-gray-600">重复消息</div>
                                </div>
                            </div>

                            <!-- DLQ消息列表 -->
                            <div class="mb-4">
                                <h4 class="text-lg font-medium text-gray-900 mb-3">
                                    死信队列消息
                                    ${messageIds && messageIds.length > 0 ?
                                        `<span class="text-sm text-gray-500 font-normal">(显示本次测试结果)</span>` :
                                        ''
                                    }
                                </h4>
                                ${filteredMessages.length === 0 ?
                                    '<div class="text-center py-8 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3"></i><p>暂无死信消息</p></div>' :
                                    filteredMessages.map(msg => `
                                        <div class="border rounded-lg p-4 mb-3 bg-red-50">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <div class="font-medium text-gray-900">${msg.originalMessageId}</div>
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        客户: ${msg.customerName} | 金额: $${msg.amount}
                                                    </div>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        失败原因: ${msg.failureReason}
                                                    </div>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        失败时间: ${new Date(msg.failureTimestamp).toLocaleString()}
                                                    </div>
                                                </div>
                                                <button onclick="retryDLQMessage('${msg.id}')" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 transition-colors text-sm">
                                                    <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-1"></i>
                                                    重试
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // 重新初始化图标
                lucide.createIcons();

                // 更新顶部统计数据
                await updateStats();

                // 更新已处理消息和死信队列
                loadMessageQueue();
                loadDeadLetterQueue();

                showNotification('DLQ结果已加载', 'success');
            } catch (error) {
                showNotification('获取DLQ结果失败: ' + error.message, 'error');
            }
        }

        // 显示快速测试结果 - 支持消息ID过滤
        async function showRapidTestResults(title, messageId) {
            try {
                // 获取所有相关数据
                const [dlqResponse, ordersResponse, messageQueueResponse, statsResponse] = await Promise.all([
                    fetch('/api/dead-letter-queue'),
                    fetch('/api/orders'),
                    fetch('/api/message-queue'),
                    fetch('/api/dead-letter-queue')
                ]);

                const dlqData = await dlqResponse.json();
                const ordersData = await ordersResponse.json();
                const messageQueueData = await messageQueueResponse.json();
                const statsData = await statsResponse.json();

                // 过滤只显示本次测试相关的数据
                const filteredDLQMessages = dlqData.messages.filter(msg =>
                    msg.originalMessageId === messageId
                );
                const filteredOrders = ordersData.filter(order =>
                    order.messageId === messageId
                );
                const filteredMessageQueue = messageQueueData.filter(msg =>
                    msg.messageId === messageId
                );

                // 计算测试特定统计
                const testStats = {
                    totalProcessed: 3, // 发送了3个请求
                    successfulOrders: filteredOrders.length,
                    duplicateMessages: 3 - filteredOrders.length, // 总数减去成功订单就是重复数
                    deadLetterMessages: filteredDLQMessages.length
                };

                // 创建模态框显示结果
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h3 class="text-xl font-semibold text-gray-900">${title}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center">
                                    <i data-lucide="target" class="w-5 h-5 text-green-600 mr-2"></i>
                                    <span class="text-green-800 font-medium">显示本次快速测试结果 (Message ID: ${messageId})</span>
                                </div>
                                <div class="mt-2 text-sm text-green-700">
                                    发送了3个相同请求，成功处理${testStats.successfulOrders}个订单，检测到${testStats.duplicateMessages}个重复消息
                                </div>
                            </div>

                            <!-- 测试统计信息 -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600">${testStats.totalProcessed}</div>
                                    <div class="text-sm text-gray-600">总请求数</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600">${testStats.successfulOrders}</div>
                                    <div class="text-sm text-gray-600">成功订单</div>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-yellow-600">${testStats.duplicateMessages}</div>
                                    <div class="text-sm text-gray-600">重复消息</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-red-600">${testStats.deadLetterMessages}</div>
                                    <div class="text-sm text-gray-600">死信消息</div>
                                </div>
                            </div>

                            <!-- 详细信息标签页 -->
                            <div class="border-b border-gray-200 mb-4">
                                <nav class="-mb-px flex space-x-8">
                                    <button onclick="showTestTab('orders', '${messageId}')" class="tab-btn active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                                        订单详情
                                    </button>
                                    <button onclick="showTestTab('messageQueue', '${messageId}')" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        消息队列
                                    </button>
                                    <button onclick="showTestTab('dlq', '${messageId}')" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        死信队列
                                    </button>
                                </nav>
                            </div>

                            <!-- 标签页内容 -->
                            <div id="ordersTab" class="tab-content">
                                <h4 class="text-lg font-medium text-gray-900 mb-3">成功订单</h4>
                                ${filteredOrders.length === 0 ?
                                    '<div class="text-center py-8 text-gray-500"><i data-lucide="package" class="w-12 h-12 mx-auto mb-3"></i><p>暂无订单数据</p></div>' :
                                    filteredOrders.map(order => `
                                        <div class="border rounded-lg p-4 mb-3 bg-green-50">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <div class="font-medium text-gray-900">订单ID: ${order.id}</div>
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        客户: ${order.customerName} | 金额: $${order.amount}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-sm text-gray-600">状态: ${order.status}</div>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        创建时间: ${new Date(order.createdAt).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>

                            <div id="messageQueueTab" class="tab-content hidden">
                                <h4 class="text-lg font-medium text-gray-900 mb-3">消息队列</h4>
                                ${filteredMessageQueue.length === 0 ?
                                    '<div class="text-center py-8 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3"></i><p>暂无消息队列数据</p></div>' :
                                    filteredMessageQueue.map(msg => `
                                        <div class="border rounded-lg p-4 mb-3 bg-blue-50">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <div class="font-medium text-gray-900">${msg.messageId}</div>
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        客户: ${msg.customerName} | 金额: $${msg.amount}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-sm text-gray-600">状态: ${msg.status}</div>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        处理时间: ${new Date(msg.processedAt).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>

                            <div id="dlqTab" class="tab-content hidden">
                                <h4 class="text-lg font-medium text-gray-900 mb-3">死信队列</h4>
                                ${filteredDLQMessages.length === 0 ?
                                    '<div class="text-center py-8 text-gray-500"><i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-3"></i><p>暂无死信消息</p></div>' :
                                    filteredDLQMessages.map(msg => `
                                        <div class="border rounded-lg p-4 mb-3 bg-red-50">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <div class="font-medium text-gray-900">${msg.originalMessageId}</div>
                                                    <div class="text-sm text-gray-600 mt-1">
                                                        客户: ${msg.customerName} | 金额: $${msg.amount}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-sm text-gray-600">失败原因: ${msg.failureReason}</div>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        失败时间: ${new Date(msg.failureTimestamp).toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // 重新初始化图标
                lucide.createIcons();

                // 更新顶部统计数据
                await updateStats();

                // 更新已处理消息和死信队列
                loadMessageQueue();
                loadDeadLetterQueue();

                showNotification('快速测试结果已加载', 'success');
            } catch (error) {
                showNotification('获取快速测试结果失败: ' + error.message, 'error');
            }
        }

        // 标签页切换功能
        function showTestTab(tabName, messageId) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // 显示选中的标签页
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            // 更新标签按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            event.target.classList.add('active', 'border-blue-500', 'text-blue-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');
        }

        // 刷新快速测试结果
        async function refreshRapidTestResults(title, messageId) {
            const modal = document.querySelector('.fixed');
            if (modal) {
                modal.remove();
                await showRapidTestResults(title, messageId);
            }
        }

        // 在模态框中重试DLQ消息
        async function retryDLQMessage(messageId) {
            try {
                const response = await fetch(`/api/dead-letter-queue/${messageId}/retry`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('消息已标记为重试', 'success');
                    // 更新顶部统计数据
                    await updateStats();
                    // 刷新模态框内容
                    setTimeout(() => {
                        refreshDLQInModal();
                    }, 1000);
                } else {
                    showNotification('重试失败', 'error');
                }
            } catch (error) {
                showNotification('重试失败: ' + error.message, 'error');
            }
        }

        // 在模态框中刷新DLQ
        async function refreshDLQInModal(title, messageIds = null) {
            const modal = document.querySelector('.fixed');
            if (modal) {
                const modalTitle = modal.querySelector('h3').textContent;
                modal.remove();
                await showDLQResults(modalTitle, messageIds);
            }
        }

        // 从模态框中清空DLQ
        async function clearDLQFromModal() {
            if (confirm('确定要清理所有死信消息吗？此操作不可撤销。')) {
                try {
                    const response = await fetch('/api/clear', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        showNotification('DLQ清理成功！所有数据已清除。', 'success');
                        // 更新顶部统计数据
                        await updateStats();
                        // 刷新模态框内容
                        setTimeout(() => {
                            refreshDLQInModal();
                        }, 1000);
                    } else {
                        showNotification('清理失败', 'error');
                    }
                } catch (error) {
                    showNotification('清理失败: ' + error.message, 'error');
                }
            }
        }

        // 重试死信消息（用于统计详情模态框）
        async function retryDeadLetterMessage(id) {
            try {
                const response = await fetch(`/api/dead-letter-queue/${id}/retry`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('消息已标记为重试', 'success');
                    // 更新顶部统计数据
                    await updateStats();
                    // 重新显示统计详情
                    setTimeout(() => {
                        showStatsDetails('deadLetter');
                    }, 1000);
                } else {
                    showNotification('重试失败', 'error');
                }
            } catch (error) {
                showNotification('重试失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>